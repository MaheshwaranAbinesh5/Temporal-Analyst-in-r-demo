```{r}
packages <- c("readr", "dplyr", "tidyr", "ggplot2", "broom", "lubridate", "countrycode", "scales")
installed <- packages %in% rownames(installed.packages())
if (any(!installed)) {
install.packages(packages[!installed], dependencies = TRUE)
}
invisible(lapply(packages, library, character.only = TRUE))

```
```{r}
file_path <- "C:\\Users\\USER\\Desktop\\Temporal-Analyst-in-r-demo\\who_ambient_air_quality_database_version_2024_(v6.1) (1).csv"
```

```{r}
raw <- read_csv(file_path)
```
```{r}
glimpse(raw)
colnames(raw)

```
```{r}
names(raw) <- make.names(names(raw), unique = TRUE)
```

```{r}
possible_years <- c("Year", "year", "Measurement.Year", "Year.of.measurement", "measurement_year")
possible_country <- c("Country", "country", "Country.or.Territory", "CountryName", "Country/Territory")
possible_pm25 <- c("PM2.5", "PM2.5..µg.m.3.", "PM2.5..ug.m.3.", "PM25", "pm2_5", "PM2_5")
possible_pm10 <- c("PM10", "PM10..µg.m.3.", "PM10..ug.m.3.", "pm10")
possible_no2 <- c("NO2", "NO2..µg.m.3.", "NO2..ug.m.3.", "no2")
possible_o3 <- c("O3", "Ozone", "o3")

```

```{r}
find_col <- function(df, candidates) {
nm <- names(df)


found <- intersect(nm, candidates)
if (length(found) > 0) return(found[1])

cand_norm <- tolower(gsub("[^a-z0-9]", "", candidates))
nm_norm <- tolower(gsub("[^a-z0-9]", "", nm))
for (i in seq_along(candidates)) {
m <- which(grepl(cand_norm[i], nm_norm, fixed = TRUE))
if (length(m) > 0) return(nm[m[1]])
}
return(NA_character_)
}

```

```{r}
col_year <- find_col(raw, possible_years)
col_country <- find_col(raw, possible_country)
col_pm25 <- find_col(raw, possible_pm25)
col_pm10 <- find_col(raw, possible_pm10)
col_no2 <- find_col(raw, possible_no2)
col_o3 <- find_col(raw, possible_o3)


```


```{r}
col_year <- find_col(raw, possible_years)
col_country <- find_col(raw, possible_country)
col_pm25 <- find_col(raw, possible_pm25)
col_pm10 <- find_col(raw, possible_pm10)
col_no2 <- find_col(raw, possible_no2)
col_o3 <- find_col(raw, possible_o3)

```

```{r}
if (is.na(col_year) || is.na(col_country) || (is.na(col_pm25) && is.na(col_pm10))) {
stop("Critical columns not detected automatically. Inspect column names and modify detection rules or set file_path correctly.")
}

```

```{r}
library(magrittr)
library(countrycode)
library(tidyverse)
```




```{r}
df <- raw %>%
dplyr::select(
Year = all_of(col_year),
Country = all_of(col_country),
PM25 = any_of(col_pm25),
PM10 = any_of(col_pm10),
NO2 = any_of(col_no2),
O3 = any_of(col_o3)
) %>%
mutate(
Year = as.numeric(Year),
PM25 = as.numeric(PM25),
PM10 = as.numeric(PM10),
NO2 = as.numeric(NO2),
O3 = as.numeric(O3),
Country = as.character(Country)
)
df <- df %>% mutate(Continent = countrycode(Country, origin = "country.name", destination = "continent"))
```

```{r}
glimpse(df)
summary(df)

```

















